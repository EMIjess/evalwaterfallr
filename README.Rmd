---
output:
  md_document:
    variant: markdown_github
references:
- id: kasmanetaliepec2015
  title: Development of Order-Independent Waterfall Graphics to Enable Comprehensive Understanding of Impact Evaluation Results
  author:
  - family: Kasman
    given: Robert
  - family: Scheer
    given: Adam  
  - family: Sackman
    given: Rachel
  - family: Friedmann
    given: Rafael
  - family: Berman
    given: Janice
  container-title: Proceedings of the 2015 International Energy Program Evaluation Conference
  volume: Long Beach, California
  issued:
    year: 2015
    month: 8  
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "README-"
)
```

## Motivation
This package is intended to provide a simple visualization of performance for energy efficiency programs, as argued by @kasmanetaliepec2015. In energy efficiency, expected program impacts are reported (_ex ante_) and then later evaluated (_ex post_). The evaluated savings, when different from the reported values are generally accompanied with reasons, or factors/parameters, explaining the source of changes. However, the order in which the factors are presented can influence how important each factor appears. Permuting the factors to order independent values removes the bias of order.  
For an explicit example (taken from @kasmanetaliepec2015), consider a lighting program with the following key values provided: 
```{r}
Gross.XA <- 100 # reported Gross Savings (arbitrary units)
NTG.XA <- 0.8 # 90% NTG reported
Net.XA <- Gross.XA*NTG.XA
Net.XA #80
NTG.XP <- 0.6 # 80% NTG found in evaluation
Gross.XP <- 50 # Gross Savings found in evaluation (arbitrary units)
Net.XP <- Gross.XP*NTG.XP
Net.XP #30
```
The source of difference between the reported savings of `r Net.XA` to the evaluated result of `r Net.XP` is going to be critical for program improvements. 

Let's assume that the evaluator advises that the following impact parameters are driving the estimate of evaluated gross (_ex post_ or `Gross.XP`) values. Note that all of these are provided as a realization rate (the ratio of the evaluated parameter to the reported parameter). 
```{r}
# define impact parameters
HOU <- 0.7 # Hours of lighting use (HOU_expost/HOU_exante) smaller as evaluated
deltaWatts <- 1.14 # difference in lighting watts higher as evaluated
ISR <- 0.63 # Installation Rate (IRR_expost/IRR_exante) smaller as evaluated
```
With thes parameters, programs may want to focus on Installation Rate. However, when provided, as usual, in a table, these parameters are difficult to distill into importance. 

## Simple Visualization of Non-Permuted Values
We can create a waterfall plot that presents these values in this order.

```{r, message=FALSE, warning=FALSE}
# ensure that we have a dataframe ready to put into waterfallPrep()
myparamdf <- data.frame( # lighting example
                          params = c("HOU","deltaWatts","ISR"),
                          value = c(0.7, 1.14, 0.63),
                          stringsAsFactors = FALSE
                         )
library(evalwaterfallr)
lighting_given <- waterfallPrep(myparamdf, 
                                gross.report=100, NTG.report=0.8, NTG.eval=0.6,
                          altparamnames = NULL,
                                output="none") # none means no permutation
lighting_given
```
```{r, message=FALSE, warning=FALSE}
library(evalwaterfallr)
waterfallPlot(lighting_given)
```

This plot does not provide any information to those most interested in the net impacts. For those, we must look at the factors in an order independent way, so that we can see their impact on the net value and the gross value, in context.

## Permuted Values
This package greatly simplifies creating permuted values (compared to doing the matrix calculations in, say Excel). The function `waterfallPrep()` calculates the tables for no permutation (as shown above), gross permutation, and net permutation all at the same time, unless output is otherwise defined.
```{r}
library(evalwaterfallr)
lighting_all <- waterfallPrep(myparamdf, 
                          gross.report=100, NTG.report=0.8, NTG.eval=0.6,
                          altparamnames = NULL,
                                output="all")
lighting_gross <- lighting_all[[2]]
lighting_net <- lighting_all[[3]]
```
```{r, message=FALSE, warning=FALSE}
par(mfrow=c(1,2))
library(evalwaterfallr)
waterfallPlot(lighting_gross) # gross permutation plot
waterfallPlot(lighting_net) # net permutation plot
```

## References

